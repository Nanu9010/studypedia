{% extends 'base.html' %}
{% block title %}{{ profile_user.username }}'s Profile - StudyPedia{% endblock %}
{% load static %}
{% block content %}
<div class="container">
    <div class="profile-header">
        <div class="profile-info d-flex align-items-center mb-4">
            {% if profile_user.profile_picture and profile_user.profile_picture.name %}
                <img src="{{ profile_user.profile_picture.url }}" alt="Profile Picture" class="rounded-circle mr-3" style="width: 150px; height: 150px; object-fit: cover;">
            {% else %}
                <img src="{% static 'img/default_profile.png' %}" alt="Default Profile" class="rounded-circle mr-3" style="width: 150px; height: 150px; object-fit: cover;">
            {% endif %}
            <div class="profile-details">
                <h1 class="profile-username mb-2">@{{ profile_user.username }}</h1>
                <div class="profile-stats d-flex gap-4 mb-2">

                    <div class="stat">
                        <a href="#followers" data-tab="followers" class="tab-link">
                            <strong>{{ stats.follower_count }}</strong> followers
                        </a>
                    </div>
                    <div class="stat">
                        <a href="#following" data-tab="following" class="tab-link">
                            <strong>{{ stats.following_count }}</strong> following
                        </a>
                    </div>
                    </div>
                <div class="profile-bio">
                    <p>{{ profile_user.bio|default:"No bio yet." }}</p>
                    <p>{{ profile_user.college|default:"No college specified" }}</p>
                </div>
                <div class="profile-buttons mt-3">
                    {% if is_own_profile %}
                        <a href="{% url 'accounts:edit_profile' %}" class="btn btn-secondary mr-2">Edit Profile</a>
                        <a href="#" class="btn btn-secondary">Share Profile</a>
                    {% else %}
                        <form action="{% url 'accounts:follow_user' profile_user.username %}" method="post" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn {% if is_following %}btn-secondary{% else %}btn-primary{% endif %} mr-2">
                                {{ is_following|yesno:"Unfollow,Follow" }}
                            </button>
                        </form>
                        <a href="{% url 'messenger:start_chat' profile_user.username %}" class="btn btn-secondary">Message</a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tabs (Instagram-style) -->
        <ul class="nav nav-tabs justify-content-center mb-4 profile-tabs">
    <li class="nav-item">
        <a class="nav-link active" href="#posts" data-tab="posts">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <line x1="3" y1="9" x2="21" y2="9"/>
                <line x1="9" y1="3" x2="9" y2="21"/>
            </svg>
            <span class="d-block">Posts</span>
        </a>
    </li>

    {% if is_own_profile %}
    <li class="nav-item">
        <a class="nav-link" href="#purchases" data-tab="purchases">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 5h14v14H5V5z"/>
                <path d="M5 9h14M9 5v14"/>
            </svg>
            <span class="d-block">Purchases</span>
        </a>
    </li>

    <li class="nav-item">
        <a class="nav-link" href="#notifications" data-tab="notifications">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
            </svg>
            <span class="d-block">Notifications</span>
        </a>
    </li>
    {% endif %}
</ul>



        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Posts Grid (Default loaded) -->
            <div class="tab-pane active" id="posts" data-loaded="true">
                <div class="post-grid">
                    {% for post in posts %}
                        <div class="post-item">
                            {% if post.image %}
                                <img src="{{ post.image.url }}" alt="Post Image" class="post-image" loading="lazy">
                            {% else %}
                                <div class="text-post">
                                    <p>{{ post.content|truncatechars:100 }}</p>
                                </div>
                            {% endif %}
                        </div>
                    {% empty %}
                        <p class="text-center">No posts yet.</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Purchases (Lazy loaded) -->
            {% if is_own_profile %}
                <div class="tab-pane" id="purchases" data-loaded="false">
                    <div class="loading-spinner" style="text-align: center; padding: 2rem;">
                        <p>Loading purchases...</p>
                    </div>
                </div>

                <!-- Notifications (Lazy loaded) -->
                <div class="tab-pane" id="notifications" data-loaded="false">
                    <div class="loading-spinner" style="text-align: center; padding: 2rem;">
                        <p>Loading notifications...</p>
                    </div>
                </div>
            {% endif %}

            <!-- Followers (Lazy loaded) -->
            <div class="tab-pane" id="followers" data-loaded="false">
                <div class="loading-spinner" style="text-align: center; padding: 2rem;">
                    <p>Loading followers...</p>
                </div>
            </div>

            <!-- Following (Lazy loaded) -->
            <div class="tab-pane" id="following" data-loaded="false">
                <div class="loading-spinner" style="text-align: center; padding: 2rem;">
                    <p>Loading following...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden templates for lazy loaded content -->
<template id="purchases-template">
    <h4 class="mb-3">Purchases ({{ stats.total_purchases }})</h4>
    {% for purchase in purchases %}
        <div class="card mb-3">
            <div class="card-body">
                <h5>{{ purchase.item }} ({{ purchase.content_type.app_label|title }})</h5>
                <p><strong>Status:</strong> {{ purchase.status|title }}</p>
                <p><strong>Amount Paid:</strong> ₹{{ purchase.amount_paid }}</p>
                <p><strong>Credits Used:</strong> {{ purchase.credits_used }}</p>
                <p><strong>Purchased:</strong> {{ purchase.created_at|date:"F d, Y" }}</p>
                {% if purchase.status == 'paid' %}
                    <a href="{% url 'ecommerce:download_item' purchase.object_id %}?type={{ purchase.content_type.model }}" class="btn btn-primary">Download</a>
                {% endif %}
            </div>
        </div>
    {% empty %}
        <p class="text-center">No purchases found.</p>
    {% endfor %}

    <h4 class="mb-3 mt-4">Orders</h4>
    {% for order in orders %}
        <div class="card mb-3">
            <div class="card-body">
                <h5>Order #{{ order.id }}</h5>
                <p><strong>Status:</strong> {{ order.status|title }}</p>
                <p><strong>Total Amount:</strong> ₹{{ order.total_amount }}</p>
                <p><strong>Credits Used:</strong> {{ order.total_credits }}</p>
                <p><strong>Payment Method:</strong> {{ order.payment_method|title }}</p>
                <p><strong>Created:</strong> {{ order.created_at|date:"F d, Y" }}</p>
                <h6>Items:</h6>
                <ul>
                    {% for item in order.items.all %}
                        <li>{{ item.item }} ({{ item.content_type.app_label|title }}) - {{ item.quantity }} x ₹{{ item.price_at_purchase }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    {% empty %}
        <p class="text-center">No orders found.</p>
    {% endfor %}
</template>

<template id="notifications-template">
    {% for notif in notifications %}
        <div class="card mb-3">
            <div class="card-body d-flex align-items-center">
                <img src="{{ notif.sender.profile_picture.url|default:'/static/img/default_profile.png' }}" alt="Sender" class="rounded-circle mr-3" style="width: 40px; height: 40px; object-fit: cover;">
                <div>
                    {% if notif.type == 'follow' %}
                        <p><strong>@{{ notif.sender.username }}</strong> followed you.</p>
                    {% elif notif.type == 'comment' %}
                        <p><strong>@{{ notif.sender.username }}</strong> commented on your post.</p>
                    {% elif notif.type == 'message' %}
                        <p><strong>@{{ notif.sender.username }}</strong> sent you a message.</p>
                    {% endif %}
                    <p class="text-muted small">{{ notif.created_at|date:"F d, Y H:i" }}</p>
                </div>
            </div>
        </div>
    {% empty %}
        <p class="text-center">No notifications.</p>
    {% endfor %}
</template>

<template id="followers-template">
    <div class="follow-list">
        {% for follower in followers_page %}
            <div class="card mb-3 d-flex align-items-center">
                <img src="{{ follower.profile_picture.url|default:'/static/img/default_profile.png' }}" alt="Follower" class="rounded-circle mr-3" style="width: 40px; height: 40px; object-fit: cover;">
                <p class="mb-0"><a href="{% url 'accounts:profile' follower.username %}">@{{ follower.username }}</a></p>
            </div>
        {% endfor %}
    </div>
    <div class="text-center mt-3">
        {% if followers_page.has_previous %}
            <a href="?followers_page={{ followers_page.previous_page_number }}" class="btn btn-secondary mr-2">Previous</a>
        {% endif %}
        {% if followers_page.has_next %}
            <a href="?followers_page={{ followers_page.next_page_number }}" class="btn btn-secondary">Next</a>
        {% endif %}
    </div>
</template>

<template id="following-template">
    <div class="follow-list">
        {% for followed in following_page %}
            <div class="card mb-3 d-flex align-items-center">
                {% if followed.profile_picture and followed.profile_picture.name %}
                    <img src="{{ followed.profile_picture.url }}" alt="Following" class="rounded-circle mr-3" style="width: 40px; height: 40px; object-fit: cover;">
                {% else %}
                    <img src="{% static 'img/default_profile.png' %}" alt="Following" class="rounded-circle mr-3" style="width: 40px; height: 40px; object-fit: cover;">
                {% endif %}
                <p class="mb-0"><a href="{% url 'accounts:profile' followed.username %}">@{{ followed.username }}</a></p>
            </div>
        {% endfor %}
    </div>
    <div class="text-center mt-3">
        {% if following_page.has_previous %}
            <a href="?following_page={{ following_page.previous_page_number }}" class="btn btn-secondary mr-2">Previous</a>
        {% endif %}
        {% if following_page.has_next %}
            <a href="?following_page={{ following_page.next_page_number }}" class="btn btn-secondary">Next</a>
        {% endif %}
    </div>
</template>

{% endblock %}

{% block scripts %}
<script>
    // Tab switching with lazy loading
    document.addEventListener('DOMContentLoaded', function() {
        const tabLinks = document.querySelectorAll('.nav-link[data-tab]');
        const tabPanes = document.querySelectorAll('.tab-pane');

        // Function to show specific tab
        function showTab(tabId) {
            // Hide all tabs
            tabPanes.forEach(pane => {
                pane.classList.remove('active');
            });

            // Remove active class from all links
            tabLinks.forEach(link => {
                link.classList.remove('active');
            });

            // Show selected tab
            const selectedTab = document.getElementById(tabId);
            const selectedLink = document.querySelector(`[data-tab="${tabId}"]`);

            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            if (selectedLink) {
                selectedLink.classList.add('active');
            }

            // Lazy load content if not already loaded
            if (selectedTab && selectedTab.dataset.loaded === 'false') {
                loadTabContent(tabId);
            }
        }

        // Function to load tab content
        function loadTabContent(tabId) {
            const tabPane = document.getElementById(tabId);
            const template = document.getElementById(`${tabId}-template`);

            if (template) {
                // Simulate loading delay (remove in production or make actual AJAX call)
                setTimeout(() => {
                    tabPane.innerHTML = template.innerHTML;
                    tabPane.dataset.loaded = 'true';
                }, 300);
            } else {
                // If no template exists, mark as loaded
                tabPane.dataset.loaded = 'true';
            }
        }

        // Add click event to all tab links
        tabLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const tabId = this.dataset.tab;
                showTab(tabId);

                // Update URL hash
                window.location.hash = tabId;
            });
        });

        // Handle initial hash on page load
        if (window.location.hash) {
            const tabId = window.location.hash.substring(1);
            if (document.getElementById(tabId)) {
                showTab(tabId);
            }
        }

        // Handle browser back/forward
        window.addEventListener('hashchange', function() {
            if (window.location.hash) {
                const tabId = window.location.hash.substring(1);
                if (document.getElementById(tabId)) {
                    showTab(tabId);
                }
            }
        });
    });

    // Smooth scroll and highlight for hash links
    window.onload = function() {
        const hash = window.location.hash;
        if (hash) {
            const element = document.querySelector(hash);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                element.style.transition = "background-color 1s ease";
                element.style.backgroundColor = "var(--hover-color)";
                setTimeout(() => { element.style.backgroundColor = ""; }, 2000);
            }
        }
    };
</script>
{% endblock %}