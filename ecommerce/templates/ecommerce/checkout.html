{% extends 'base.html' %}
{% block content %}
<div class="container">
    <h1>Checkout</h1>

    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="message {{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="card">
        <h3>Order Summary</h3>
        <p><strong>Subtotal:</strong> ₹{{ total_amount }}</p>
        {% if discount > 0 %}
            <p><strong>Discount ({{ coupon.code }}):</strong> -₹{{ discount }}</p>
        {% endif %}
        <p><strong>Shipping:</strong> ₹0.00</p>
        <p><strong>Total:</strong> ₹{{ final_amount }}</p>
        <p><strong>Total Credits:</strong> {{ total_credits }}</p>

        <form method="post" action="{% url 'ecommerce:checkout' %}">
            {% csrf_token %}
            <div class="input-group mb-3">
                <input type="text" name="coupon_code" class="form-control" placeholder="Enter coupon code" {% if coupon %}value="{{ coupon.code }}" readonly{% endif %}>
                <button type="submit" class="btn btn-outline-secondary">Apply Coupon</button>
                {% if coupon %}
                    <a href="{% url 'ecommerce:checkout' %}" class="btn btn-outline-danger">Remove Coupon</a>
                {% endif %}
            </div>
        </form>

        {% if can_pay_with_credits %}
            <form method="post" action="">
                {% csrf_token %}
                <input type="hidden" name="payment_method" value="credits">
                <button type="submit" class="btn btn-primary w-100">Pay with Credits ({{ user.credits }} available)</button>
            </form>
        {% endif %}

        <form method="post" action="">
            {% csrf_token %}
            <input type="hidden" name="payment_method" value="razorpay">
            <button type="submit" class="btn btn-primary w-100">Pay with Razorpay</button>
        </form>

        {% if razorpay_order_id %}
            <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
            <script>
                var options = {
                    "key": "{{ razorpay_key_id }}",
                    "amount": "{{ amount_paise }}",
                    "currency": "INR",
                    "name": "StudyPedia",
                    "description": "Order #{{ order.id }}",
                    "order_id": "{{ razorpay_order_id }}",
                    "handler": function (response) {
                        var form = document.createElement('form');
                        form.method = 'POST';
                        form.action = "{% url 'ecommerce:payment_callback' %}";
                        var input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'razorpay_payment_id';
                        input.value = response.razorpay_payment_id;
                        form.appendChild(input);
                        input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'razorpay_order_id';
                        input.value = response.razorpay_order_id;
                        form.appendChild(input);
                        input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'razorpay_signature';
                        input.value = response.razorpay_signature;
                        form.appendChild(input);
                        document.body.appendChild(form);
                        form.submit();
                    },
                    "prefill": {
                        "name": "{{ user.username }}",
                        "email": "{{ user.email }}",
                        "contact": "{{ user.phone }}"
                    },
                    "theme": {
                        "color": "#3399cc"
                    }
                };
                var rzp = new Razorpay(options);
                rzp.open();
            </script>
        {% endif %}
    </div>
</div>
{% endblock %}